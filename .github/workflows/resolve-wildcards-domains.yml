name: Resolve Wildcards to IPs

on:
  # Roda sempre após o workflow 1 concluir
  workflow_run:
    workflows: ["Resolve Domains to IPs"]
    types:
      - completed

  # Também roda domingo às 03:00 da manhã (06:00 UTC)
  schedule:
    - cron: "0 6 * * 0"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          pip install dnspython requests

      - name: Resolve wildcards
        run: |
          python3 << 'EOF'
          import dns.resolver
          import requests
          import json

          INPUT_FILE = "allow"
          OUTPUT_FILE = "allow-ip.txt"

          resolver = dns.resolver.Resolver()
          resolver.timeout = 2
          resolver.lifetime = 2

          final_ips = set()
          domains_to_resolve = set()
          wildcard_bases = set()

          # -------------------------------------------------------
          # 1. Ler arquivo allow
          # -------------------------------------------------------
          with open(INPUT_FILE, "r") as f:
              lines = [l.strip() for l in f if l.strip()]

          for line in lines:
              # IP direto
              if all(c.isdigit() or c == '.' for c in line):
                  final_ips.add(line)
                  continue

              # Wildcard
              if line.startswith("*."):
                  base = line[2:]
                  wildcard_bases.add(base)
                  domains_to_resolve.add(base)
              else:
                  # domínio normal
                  domains_to_resolve.add(line)

          # -------------------------------------------------------
          # 2. Resolver domínios diretos
          # -------------------------------------------------------
          def resolve_domain(domain):
              try:
                  answers = resolver.resolve(domain, "A")
                  return [a.to_text() for a in answers]
              except:
                  return []

          for d in list(domains_to_resolve):
              for ip in resolve_domain(d):
                  final_ips.add(ip)

          # -------------------------------------------------------
          # 3. Descobrir subdomínios de wildcards
          # -------------------------------------------------------
          def discover_subdomains(base):
              found = set()

              # CRT.SH
              try:
                  url = f"https://crt.sh/?q=%25.{base}&output=json"
                  data = requests.get(url, timeout=10).text
                  if data:
                      for entry in json.loads(data):
                          name = entry.get("name_value", "")
                          for sub in name.split("\n"):
                              sub = sub.strip()
                              if sub.endswith(base):
                                  found.add(sub)
              except:
                  pass

              # Bufferover
              try:
                  url = f"https://dns.bufferover.run/dns?q=.{base}"
                  r = requests.get(url, timeout=10).json()
                  for key in ("FDNS_A", "RDNS", "CNAME", "FDNS_AAAA"):
                      if key in r:
                          for item in r[key]:
                              host = item.split(",")[0]
                              if host.endswith(base):
                                  found.add(host)
              except:
                  pass

              return found

          # Resolver subdomínios descobertos
          for base in wildcard_bases:
              subs = discover_subdomains(base)
              for sub in subs:
                  for ip in resolve_domain(sub):
                      final_ips.add(ip)

          # -------------------------------------------------------
          # 4. Escrever arquivo final
          # -------------------------------------------------------
          with open(OUTPUT_FILE, "w") as f:
              for ip in sorted(final_ips):
                  f.write(ip + "\n")

          print("allow-ip.txt atualizado com wildcards!")
          EOF

      - name: Commit changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # garantir que a branch está atualizada antes do push
          git pull --rebase

          git add allow-ip.txt
          git commit -m "Atualização automática (wildcards)" || echo "Nenhuma mudança."
          git push
