name: Resolve Wildcards

concurrency:
  group: ip-update
  cancel-in-progress: false

on:
  push:
    paths:
      - allow
  schedule:
    - cron: "0 6 * * 0"  # domingo às 03:00 BRT

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          pip install dnspython

      - name: Resolve wildcards
        run: |
          python3 << 'EOF'
          import dns.resolver
          import dns.name
          import dns.query
          import dns.zone

          input_file = "allow"
          output_file = "allow-ip.txt"

          ips = set()
          wildcards = []

          try:
              with open(input_file, "r") as f:
                  entries = [line.strip() for line in f.readlines() if line.strip()]
          except FileNotFoundError:
              print("Arquivo 'allow' não encontrado.")
              entries = []

          # Identifica wildcards
          for entry in entries:
              if entry.startswith("*."):
                  wildcards.append(entry[2:])

          resolver = dns.resolver.Resolver()
          resolver.timeout = 3
          resolver.lifetime = 3

          for wildcard in wildcards:
              print(f"Buscando subdomínios de: {wildcard}")

              name = dns.name.from_text(wildcard)
              try:
                  ns_records = resolver.resolve(wildcard, 'NS')
              except:
                  continue

              for ns in ns_records:
                  ns_server = str(ns)
                  try:
                      ns_ip = resolver.resolve(ns_server, 'A')[0].to_text()
                      zone = dns.zone.from_xfr(dns.query.xfr(ns_ip, wildcard))
                      for name, node in zone.nodes.items():
                          fqdn = f"{name}.{wildcard}"
                          try:
                              answers = resolver.resolve(fqdn, "A")
                              for ans in answers:
                                  ips.add(ans.to_text())
                          except:
                              continue
                  except:
                      continue

          # Sobrescreve a lista
          with open(output_file, "w") as f:
              for ip in sorted(ips):
                  f.write(ip + "\n")

          print("Wildcard scan finalizado.")
          EOF

      - name: Commit changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add allow-ip.txt
          git commit -m "Atualização automática (wildcards)" || echo "Nenhuma mudança."

      - name: Pull latest before pushing
        run: |
          git pull --rebase

      - name: Push changes
        run: |
          git push
