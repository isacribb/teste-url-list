name: Resolve Wildcards to IPs

on:
  push:
    paths:
      - allow          # sempre rodar quando "allow" mudar

  schedule:
    - cron: "0 6 * * 0"   # Domingo às 03:00 BRT (06:00 UTC)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          pip install dnspython requests

      - name: Resolve wildcards
        run: |
          python3 << 'EOF'
          import dns.resolver
          import requests
          import json

          INPUT_FILE = "allow"
          OUTPUT_FILE = "allow-ip.txt"

          resolver = dns.resolver.Resolver()
          resolver.timeout = 2
          resolver.lifetime = 2

          final_ips = set()
          domains_to_resolve = set()

          # -------------------------------------------------------
          # 1. Ler arquivo allow
          # -------------------------------------------------------
          with open(INPUT_FILE, "r") as f:
              lines = [l.strip() for l in f if l.strip()]

          for line in lines:
              if all(c.isdigit() or c == '.' for c in line):
                  final_ips.add(line)
                  continue

              if line.startswith("*."):
                  domains_to_resolve.add(line[2:])
              else:
                  domains_to_resolve.add(line)

          def resolve_domain(domain):
              try:
                  answers = resolver.resolve(domain, "A")
                  return [a.to_text() for a in answers]
              except:
                  return []

          # Resolver domínios diretos
          for d in list(domains_to_resolve):
              for ip in resolve_domain(d):
                  final_ips.add(ip)

          # Wildcards (*.dominio)
          wildcards = [l[2:] for l in lines if l.startswith("*.")]

          # Descobrir subdomínios de wildcard
          def discover_subdomains(base):
              found = set()
              # CRT.SH
              try:
                  url = f"https://crt.sh/?q=%25.{base}&output=json"
                  data = requests.get(url, timeout=10).text
                  if data:
                      for entry in json.loads(data):
                          name = entry.get("name_value", "")
                          for sub in name.split("\n"):
                              if sub.endswith(base):
                                  found.add(sub.strip())
              except:
                  pass

              # BufferOver
              try:
                  url = f"https://dns.bufferover.run/dns?q=.{base}"
                  r = requests.get(url, timeout=10).json()
                  for key in ("FDNS_A", "RDNS", "CNAME", "FDNS_AAAA"):
                      if key in r:
                          for item in r[key]:
                              host = item.split(",")[0]
                              if host.endswith(base):
                                  found.add(host)
              except:
                  pass

              return found

          # Resolver subdomínios descobertos
          for base in wildcards:
              subs = discover_subdomains(base)

              for sub in subs:
                  for ip in resolve_domain(sub):
                      final_ips.add(ip)

          with open(OUTPUT_FILE, "w") as f:
              for ip in sorted(final_ips):
                  f.write(ip + "\n")

          print("allow-ip.txt atualizado com wildcards!")
          EOF

      - name: Commit changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add allow-ip.txt
          git commit -m "Atualização automática (wildcards)" || echo "Nenhuma mudança."
          git push
