name: Resolve wildcards

on:
  push:
    paths:
      - allow
      - wordlist.txt
  schedule:
    - cron: "0 9 * * 0" # 06:00 BRT (UTC-3) aos domingos

permissions:
  contents: write

jobs:
  wildcards:
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait 60 seconds to avoid conflicts
        run: sleep 60
        
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Install dependencies
        run: pip install dnspython
        
      - name: Resolve wildcards
        run: |
          python3 - << 'PYCODE'
          import dns.resolver
          from pathlib import Path
          
          allow_file = Path("allow")
          wordlist_file = Path("wordlist.txt")
          output_file = Path("allow-ip-wildcards.txt")
      
          ips = set()
          wildcards = set()
          prefixes = set()
      
          if allow_file.exists():
              with allow_file.open("r") as f:
                  for line in f:
                      d = line.strip()
                      if d.startswith("*.") and len(d) > 2:
                          wildcards.add(d[2:])
      
          if wordlist_file.exists():
              with wordlist_file.open("r") as f:
                  for line in f:
                      p = line.strip()
                      if p and not p.startswith("#"):
                          prefixes.add(p)
          
          if wildcards and prefixes:
              resolver = dns.resolver.Resolver()
              resolver.timeout = 3
              resolver.lifetime = 5
              
              total = len(wildcards) * len(prefixes)
              count = 0
              
              for base in sorted(wildcards):
                  for prefix in sorted(prefixes):
                      count += 1
                      fqdn = f"{prefix}.{base}"
                      
                      if count % 100 == 0:
                          print(f"Progresso: {count}/{total} - Testando {fqdn}")
                      
                      try:
                          answers = resolver.resolve(fqdn, "A")
                          for answer in answers:
                              ip = answer.to_text()
                              ips.add(ip)
                              print(f"✓ {fqdn} → {ip}")
                      except dns.resolver.NXDOMAIN:
                          pass
                      except dns.resolver.NoAnswer:
                          pass
                      except dns.resolver.Timeout:
                          print(f"⏱ Timeout: {fqdn}")
                      except Exception as e:
                          print(f"✗ Erro em {fqdn}: {e}")
          
          with output_file.open("w") as f:
              for ip in sorted(ips, key=lambda x: tuple(map(int, x.split('.')))):
                  f.write(ip + "\n")
          
          print(f"\n✓ Total de IPs únicos resolvidos: {len(ips)}")
          PYCODE
          
      - name: Commit wildcards and merge IPs
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add allow-ip-wildcards.txt
          if git diff --cached --quiet; then
            echo "Sem mudanças em allow-ip-wildcards.txt."
          else
            git commit -m "Atualização automática (wildcards via wordlist) - $(date +'%Y-%m-%d %H:%M')"
          fi

          # Garante arquivos para o merge
          touch allow-ip-domains.txt
          touch allow-ip-wildcards.txt

          # Merge domains + wildcards -> allow-ip.txt
          cat allow-ip-domains.txt allow-ip-wildcards.txt \
            | sed '/^[[:space:]]*$/d' \
            | sort -u > allow-ip.txt

          git add allow-ip.txt
          if git diff --cached --quiet; then
            echo "Sem mudanças em allow-ip.txt."
            exit 0
          fi

          git commit -m "Merge domains + wildcard IPs into allow-ip.txt"
          git pull --rebase origin main || true
          git push origin main || git push origin main --force
