on:
  push:
    paths:
    - allow
    - wordlist.txt
  schedule:
  - cron: "0 9 * * 0" # 06:00 BRT (UTC-3) aos domingos

permissions:
  contents: write

jobs:
  wildcards:
    runs-on: ubuntu-latest
    
    steps:  # ‚Üê CORRE√á√ÉO: Identa√ß√£o correta (2 espa√ßos)
      - name: Wait 60 seconds to avoid conflicts
        run: sleep 60
        
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Install dependencies
        run: pip install dnspython
        
      - name: Resolve wildcards
        run: |
          python3 - << 'PYCODE'
          import dns.resolver
          from pathlib import Path
          
          allow_file = Path("allow")
          wordlist_file = Path("wordlist.txt")
          output_file = Path("allow-ip-wildcards.txt")
      
          ips = set()
          wildcards = set()
          prefixes = set()
      
          # L√™ wildcards do arquivo allow
          if allow_file.exists():
              with allow_file.open("r") as f:
                  for line in f:
                      d = line.strip()
                      if d.startswith("*.") and len(d) > 2:
                          wildcards.add(d[2:])
      
          # L√™ prefixos da wordlist
          if wordlist_file.exists():
              with wordlist_file.open("r") as f:
                  for line in f:
                      p = line.strip()
                      if p and not p.startswith("#"):
                          prefixes.add(p)
          
          # Resolve DNS para cada combina√ß√£o
          if wildcards and prefixes:
              resolver = dns.resolver.Resolver()
              resolver.timeout = 3  # MELHORIA: Aumentei timeout
              resolver.lifetime = 5
              
              total = len(wildcards) * len(prefixes)
              count = 0
              
              for base in sorted(wildcards):
                  for prefix in sorted(prefixes):
                      count += 1
                      fqdn = f"{prefix}.{base}"
                      
                      # Log de progresso
                      if count % 100 == 0:
                          print(f"Progresso: {count}/{total} - Testando {fqdn}")
                      
                      try:
                          answers = resolver.resolve(fqdn, "A")
                          for answer in answers:
                              ip = answer.to_text()
                              ips.add(ip)
                              print(f"‚úì {fqdn} ‚Üí {ip}")
                      except dns.resolver.NXDOMAIN:
                          pass  # Dom√≠nio n√£o existe
                      except dns.resolver.NoAnswer:
                          pass  # Sem resposta A
                      except dns.resolver.Timeout:
                          print(f"‚è± Timeout: {fqdn}")
                      except Exception as e:
                          print(f"‚úó Erro em {fqdn}: {e}")
          
          # Salva IPs √∫nicos ordenados
          with output_file.open("w") as f:
              for ip in sorted(ips, key=lambda x: tuple(map(int, x.split('.')))):
                  f.write(ip + "\n")
          
          print(f"\n‚úì Total de IPs √∫nicos resolvidos: {len(ips)}")
          PYCODE
          
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add allow-ip-wildcards.txt
          
          # Verifica se h√° mudan√ßas
          if git diff --cached --quiet; then
            echo "Sem mudan√ßas para commitar."
            exit 0
          fi
          
          git commit -m "ü§ñ Atualiza√ß√£o autom√°tica (wildcards via wordlist) - $(date +'%Y-%m-%d %H:%M')"
          git pull --rebase origin main || true
          git push origin main
